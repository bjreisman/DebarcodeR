---
title: "DebarcodeR Example"
author: "Benjamin Reisman and Sierra Barone"
date: "03/16/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libraries and read in data

Load flowCore, tidyverse, and debarcoder packages. Read in FCS files for the stained sample and the uptake control sample

```{r setup}

# load libraries
library(flowCore)
library(debarcoder)
library(tidyverse)
library(ggplot2)

# read in FCS files for barcoded and uptake control samples
barcoded.ff <- read.FCS("stained.fcs")
uptake.ff <- read.FCS("uptake.fcs")

```

# Create debarcoder object

Create flowFrame FCB with slots filled with barcoded and uptake samples

```{r create debarcodeR object}

# test class of flowFrameFCB object
class(flowFrameFCB)

# create flowFrameFCB object using barcoded and uptake control sample as flowFrames
flowFrameFCB <- flowFrameFCB(barcoded.ff,uptake.ff)
                              
# plot Pacific Blue and Pacific Orange histograms 
hist(flowFrameFCB@barcoded.ff@exprs[,11], n= 600, main = NULL, xlab = "Pacific Blue")
hist(flowFrameFCB@barcoded.ff@exprs[,12], n= 600, main = NULL, xlab = "Pacific Orange")

```
# Deskew barcoding channel using a regression method

Deskew each barcoding channel individually choosing predictors, method, and channel
```{r deksew flowFrameFCB data}

# Input debarcoder object and choose predictors, method, and channel to deskew (BC1)
# Deskew first barcoded channel
deskewedFCB <- deskew_flowFrameFCB(flowFrameFCB, ret.model = T, predictors = c("fsc_a","ssc_a"), channel = c("pacific_blue_a"), method = c("earth"))

# Input new deskewed object and deskew new barcoded channel
deskewedFCB <- deskew_flowFrameFCB(deskewedFCB, ret.model = T, predictors = c("fsc_a","ssc_a"), channel = c("pacific_orange_a"), method = c("earth"))

# plot deskewed histrogram of Pacific Blue and Pacific Orange
hist(deskewedFCB@barcodes$pacific_blue_a$deskewing$values, n = 700, main = NULL, xlab = "Pacific Blue")
hist(deskewedFCB@barcodes$pacific_orange_a$deskewing$values, n = 700, main = NULL, xlab = "Pacific Orange")

plot.deskewed = as.data.frame(cbind( deskewedFCB@barcodes$pacific_orange_a$deskewing$values,  deskewedFCB@barcodes$pacific_blue_a$deskewing$values))

  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_blue_a, y = `Alexa Fluor 700-A`)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()

  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_orange_a, y = `Alexa Fluor 700-A`)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()
  
  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_orange_a, y = pacific_blue_a)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()
```
# Apply clustering and modeling to deskewed flowFrameFCB

Calculate probabilities of cells belonging to a level of barcode
```{r modeling}

# Input deskewed debarcoder object and choose number of levels, option, distribution, and channel to cluster (BC1)
# Cluster first barcoded channel
clusteredFCB <- cluster_flowFrameFCB(deskewedFCB, channel = c("pacific_blue_a"), levels = 8, opt = "mixture", dist = "Skew.normal")

# Input new clustered object and cluster new barcoded channel
clusteredFCB <- cluster_flowFrameFCB(clusteredFCB, channel = c("pacific_orange_a"), levels = 6, opt = "mixture", dist = "Skew.normal")

```
# Assign cells to levels of barcode based on ambiguity and uncertainty

Assign cells to levels based on probabilities and various cutoffs
```{r assignment}

# Input clustered debarcoder object and choose likelihood cutoff, ambiguity cutoff, and channel to assign(BC1)
# Assign cells to levels of first barcoded channel
assignmentFCB <- assign_flowFrameFCB(clusteredFCB, channel = c("pacific_blue_a") , likelihoodcut = 8, ambiguitycut = 0.2)

# Input new f;owFrameFCB with assignments and apply assignments to other barcoded channel
assignmentFCB <- assign_flowFrameFCB(assignmentFCB, channel = c("pacific_orange_a") , likelihoodcut = 8, ambiguitycut = 0.2)

mypal <- c("grey50", scales::hue_pal()(length(unique(assignmentFCB@barcodes$pacific_blue_a$assignment$values))-1))

bind_cols(plot.deskewed) %>%
  mutate(pblevel = as.factor(assignmentFCB@barcodes$pacific_blue_a$assignment$values)) %>%
  ggplot(aes(x=pacific_blue_a, fill = pblevel)) +
  geom_histogram(bins = 300)  +
  scale_fill_manual(values = mypal) + theme_bw()

bind_cols(plot.deskewed) %>%
  mutate(polevel = as.factor(assignmentFCB@barcodes$pacific_orange_a$assignment$values)) %>%
  ggplot(aes(x=pacific_orange_a, fill = polevel)) +
  geom_histogram(bins = 300)  +
  scale_fill_manual(values = mypal) + theme_bw()

# Write new FCS files per well 
debarcoded.fs <- as.flowSet(assignmentFCB)

probs.norm.row <- calculate.ambiguity(clusteredFCB,channel = c("pacific_blue_a"))
probs.norm.col <- calculate.likelihood(clusteredFCB,channel = c("pacific_blue_a"))
classif <- as.numeric(apply(probs.norm.row, 1, which.max))

test <- list()
count = 1
for (i in rev(seq(0.01,1,by = 0.01))){
non.ambiguous <- apply(probs.norm.row, 1, max) > (1 - i)
not.am = classif[which(non.ambiguous)]
test[[count]] = summary(as.factor(not.am))
count = count + 1}

counts = plyr::ldply(test,rbind)
counts$cutoff = rev(seq(0.01,1,by = 0.01))

meltR = reshape2::melt(counts, id.vars = "cutoff", measure.vars = c(1:8))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()


tests <- list()
counting = 1

for (s in rev(seq(2,100,by = 1))){
    likely <- probs.norm.col > 1/s
    likely.sum <- apply(likely, 1, sum) 
    most.likely = classif[which(likely.sum > 0)]
tests[[counting]] = summary(as.factor(most.likely))
counting = counting + 1}

look.at.counts = plyr::ldply(tests,rbind)
look.at.counts$cutoff = rev(seq(2,100,by = 1))

meltR = reshape2::melt(look.at.counts, id.vars = "cutoff", measure.vars = c(1:8))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()


probs.norm.row <- calculate.ambiguity(clusteredFCB,channel = c("pacific_orange_a"))
probs.norm.col <- calculate.likelihood(clusteredFCB,channel = c("pacific_orange_a"))
classif <- as.numeric(apply(probs.norm.row, 1, which.max))

test <- list()
count = 1
for (i in rev(seq(0.01,1,by = 0.01))){
non.ambiguous <- apply(probs.norm.row, 1, max) > (1 - i)
not.am = classif[which(non.ambiguous)]
test[[count]] = summary(as.factor(not.am))
count = count + 1}

counts = plyr::ldply(test,rbind)
counts$cutoff = rev(seq(0.01,1,by = 0.01))

meltR = reshape2::melt(counts, id.vars = "cutoff", measure.vars = c(1:6))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()


tests <- list()
counting = 1
for (s in rev(seq(2,100,by = 1))){
    likely <- probs.norm.col > 1/s
    likely.sum <- apply(likely, 1, sum) 
    most.likely = classif[which(likely.sum > 0)]
tests[[counting]] = summary(as.factor(most.likely))
counting = counting + 1}

look.at.counts = plyr::ldply(tests,rbind)
look.at.counts$cutoff = rev(seq(2,100,by = 1))

meltR = reshape2::melt(look.at.counts, id.vars = "cutoff", measure.vars = c(1:6))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()

```

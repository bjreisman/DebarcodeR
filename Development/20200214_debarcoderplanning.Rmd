---
title: "Debarcoder Planning"
author: "Benjamin Reisman and Sierra Barone"
date: "03/09/2020"
output: html_document
---

```{r test}
library(flowCore)
library(debarcoder)
library(earth)
library(janitor)

barcoded.ff <- read.FCS("stained.fcs")
uptake.ff <- read.FCS("uptake.fcs")
flowFrameFCB <- flowFrameFCB(barcoded.ff, uptake.ff)
class(flowFrameFCB )

deskewedFCB <- deskew_flowFrameFCB(flowFrameFCB, ret.model = T,predictors = c("fsc_a","ssc_a"), channel = c("pacific_blue_a"), method = c("earth"))

deskewedFCB1 <- deskew_flowFrameFCB(deskewedFCB, ret.model = T,predictors = c("fsc_a","ssc_a"), channel = c("pacific_orange_a"), method = c("earth"))

clusteredFCB <- cluster_flowFrameFCB(deskewedFCB, channel = c("pacific_blue_a"), levels = 8, opt = "mixture", dist = "Skew.normal")

assignment <- assign_flowFrameFCB(clusteredFCB, channel = c("pacific_blue_a") ,likelihoodcut = 8,ambiguitycut = 0.02)
```

```{r some plots}
hist(flowFrameFCB@barcoded.ff@exprs[,11], n= 500)
hist(deskewedFCB@barcodes$pacific_blue_a$deskewing$values, n = 500)

# function that takes prob matrix and returns ambiguity and uncertainity 
# norm by row, col
# 2 functions (1 for row, 1 for col)

assign()
# call prior function for cutoffs 

# 4 
# levels to naming files
# split.flowframeFCB(flowFrameFCB, platemap) --> return(FlowSet with og file name & "label"/"level") generic function to split

# pass labels, append to levels
# lookup table
# csv table for levels and names
# platemap = csv template
# read in file and assign/label/match

# plots for cutoffs and distributions 
# reprex for example data set (reproducible)
# load barcoded flowFrame

# name for channel to recognize pacific blue regardless of case and spaces 
# have user select channel 
# find closest match for ssc,fsc, pb, po, etc
```

```{r debarcoder final}
generate_debarcoding_report()
plot(debarcoded.s3, what = "deskew")
finalize.bc(debarcoded.s3) #=>flowset
```

---
title: "DebarcodeR Example"
author: "Benjamin Reisman and Sierra Barone"
date: "03/16/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libraries and read in data

Load flowCore, tidyverse, and debarcoder packages. Read in FCS files for the stained sample and the uptake control sample

```{r setup}

# load libraries
library(flowCore)
library(debarcoder)
library(tidyverse)
library(ggplot2)

# read in FCS files for barcoded and uptake control samples
barcoded.ff <- read.FCS("stained.fcs")
uptake.ff <- read.FCS("uptake.fcs")
summary(barcoded.ff@exprs)
```

# Create debarcoder object

Create flowFrame FCB with slots filled with barcoded and uptake samples

```{r create debarcodeR object}

# create flowFrameFCB object using barcoded and uptake control sample as flowFrames
flowFrameFCB <- flowFrameFCB(barcoded.ff, uptake.ff)

# test class of flowFrameFCB object
class(flowFrameFCB)

# plot Pacific Blue and Pacific Orange histograms 
hist(flowFrameFCB@barcoded.ff@exprs[,11], n= 600, main = NULL, xlab = "Pacific Blue")
hist(flowFrameFCB@barcoded.ff@exprs[,12], n= 600, main = NULL, xlab = "Pacific Orange")

```
# Deskew barcoding channel using a regression method

Deskew each barcoding channel individually choosing predictors, method, and channel
```{r deksew flowFrameFCB data}

# Input debarcoder object and choose predictors, method, and channel to deskew (BC1)
# Deskew first barcoded channel
deskewedFCB <- deskew_flowFrameFCB(flowFrameFCB, ret.model = T, predictors = c("fsc_a","ssc_a"), channel = c("pacific_blue_a"), method = c("earth"))

# Input new deskewed object and deskew new barcoded channel
deskewedFCB <- deskew_flowFrameFCB(deskewedFCB, ret.model = T, predictors = c("fsc_a","ssc_a"), channel = c("pacific_orange_a"), method = c("earth"))

# plot deskewed histrogram of Pacific Blue and Pacific Orange
hist(deskewedFCB@barcodes$pacific_blue_a$deskewing$values, n = 700, main = NULL, xlab = "Pacific Blue")
hist(deskewedFCB@barcodes$pacific_orange_a$deskewing$values, n = 700, main = NULL, xlab = "Pacific Orange")

```
# Apply clustering and modeling to deskewed flowFrameFCB

Calculate probabilities of cells belonging to a level of barcode
```{r modeling}

# Input deskewed debarcoder object and choose number of levels, option, distribution, and channel to cluster (BC1)
# Cluster first barcoded channel
clusteredFCB <- cluster_flowFrameFCB(deskewedFCB, channel = c("pacific_blue_a"), levels = 3, opt = "mixture", dist = "Skew.normal")

# Input new clustered object and cluster new barcoded channel
clusteredFCB <- cluster_flowFrameFCB(clusteredFCB, channel = c("pacific_orange_a"), levels = 2, opt = "mixture", dist = "Skew.normal")

```
# Assign cells to levels of barcode based on ambiguity and uncertainty

Assign cells to levels based on probabilities and various cutoffs
```{r assignment}

# Input clustered debarcoder object and choose likelihood cutoff, ambiguity cutoff, and channel to assign(BC1)
# Assign cells to levels of first barcoded channel
assignmentFCB <- assign_flowFrameFCB(clusteredFCB, channel = c("pacific_blue_a") , likelihoodcut = 8, ambiguitycut = 0.02)

# Input new f;owFrameFCB with assignments and apply assignments to other barcoded channel
assignmentFCB <- assign_flowFrameFCB(assignmentFCB, channel = c("pacific_orange_a") , likelihoodcut = 8, ambiguitycut = 0.02)

# Write new FCS files per well 
debarcoded.fs <- as.flowSet(assignmentFCB)

```

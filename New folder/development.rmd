---
title: "DebarcodeR Development"
author: "Benjamin Reisman"
date: "October 25, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r setup}
library(cytotidyr)
library(flowCore)
library(tidyverse)
library(CytobankAPI)
library(janitor)
library(reticulate)
library(scales)
library(uwot)
library(patchwork)
library(ggrastr)
use_python("C:/Users/benja/AppData/Roaming/Python/Python37")


token <- "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzOTI3ZDg0ZmQ1ZDFiZmNmOTJiM2NlMzhmNWQyYWNlMSIsImV4cCI6MTU0MDY5NDUxMiwidXNlcl9pZCI6MTQ3LCJhdWQiOiJjeXRvYmFua19hcGlfdjFfdXNlcnMiLCJpYXQiOjE1NDA2NjU3MTIsImlzcyI6Imh0dHBzOi8vdmFuZGVyYmlsdC5jeXRvYmFuay5vcmcvIiwibmJmIjoxNTQwNjY1NzEyLCJzdWIiOiJjeXRvYmFua19hcGlfdjEifQ.b7IwkyxMkpY2XT_kp3XyA8YEmEAJnwDzSCoo1dVtCcg"

cyto_session <- authenticate("vanderbilt", auth_token = token)

```

```{r import data}

experiment.id <- 28284


exp_info <- get_experimentinfo(cyto_session = cyto_session, experiment.id)
#exp_info$sampletags$Conditions
st <- exp_info$sampletags
fcs.ids <- 
  exp_info$sampletags %>%
  filter(Plate == "Healthy Blood") %>%
  left_join(exp_info$fcs_files, by = c('FCS Filename' = 'filename')) %>%
  dplyr::select(id) %>%
  unlist() %>%
  as.integer()

dir.create('data')
fcs.zip.path <- fcs_files.download_zip(cyto_session, experiment.id, fcs.ids, 
                       directory = "data")


fcs.unzipped <- unzip(fcs.zip.path, exdir = "data")
```

```{r}
myflowSet<- read.flowSet(files = fcs.unzipped)
myflowSet.compensated <- compensate(myflowSet, exp_info$compensations$BJR$compensation_matrix)
myflowSet.gated <- lapply(as.list(myflowSet.compensated@frames), function(ff){
       gate_population(ff, "viable", exp_info, verbose = F)
  })


gate_population()
mydata.list <- lapply(myflowSet.gated, function(ff){
  as.tibble(exprs(ff)) %>%
    mutate(filename = description(ff)$GUID)}
  )

mydata.tidy <- 
  mydata.list %>%
  lapply(apply_scales, exp_info) %>%
  lapply(apply_panel, exp_info, "Panel 1") %>%
  lapply(clean_names, case = "old_janitor")

#mydata.tidy$`Healthy Blood_Uptake2_022.fcs`
```

```{r}
mydata.stained.ss <- mydata.tidy$`Healthy Blood_Stained_020.fcs` %>%
  sample_n(30e3)
plot.ssc_fsc<- mydata.stained.ss %>%
  ggplot(aes(x= ssc_a, y = fsc_a)) + 
  geom_bin2d(bins = 200) + 
  scale_fill_distiller(palette = "Spectral") +
  theme_bw()
ggsave('ssccfsc.png', width = 4, height = 3, units = "in", dpi =300)

plot.ssc_cd45 <- 
  mydata.stained.ss %>%
  ggplot(aes(x= ssc_a, y = cd45)) + 
  geom_bin2d(bins = 200) + 
  scale_fill_distiller(palette = "Spectral") +
  theme_bw()
plot.ssc_cd45
ggsave('ssccd45.png', width = 4, height = 3, units = "in", dpi =300)

#library(uwot)



###############3
mydata.mapping2 <- mydata.stained.ss %>%
  select(cd45, ssc_a) %>%
  mutate_all(function(col) rescale(col, c(0,7)))


umap.1 <- umap(mydata.mapping2, min_dist = 0, n_neighbors = 30, verbose = T, ret_model = TRUE)

as_tibble(umap.1$embedding) %>%
  ggplot(aes(x=V1, y = V2)) + 
  geom_point(shape = ".") + 
  theme_classic()

#####################
mydata.mapping3 <- mydata.stained.ss %>%
  select(cd45, ssc_a, fsc_a) %>%
  mutate_all(function(col) rescale(col, c(0,7)))


umap.3 <- umap(mydata.mapping3, min_dist = 0, n_neighbors = 30, verbose = T, ret_model = TRUE)
hdbscan.3 <- dbscan::hdbscan(umap.3$embedding, minPts = 50)


umap.hdbscan.3.plot <- as_tibble(umap.3$embedding) %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  ggplot(aes(x=V1, y = V2, col = cluster)) + 
  geom_point(shape = ".") + 
  scale_color_discrete(guide = guide_legend(override.aes = list(
    shape = 15
  ))) + 
  labs(subtitle = "UMAP:n_neighbors = 30, min_dist = 0\nHDBSCAN: minPts = 50") + 
  theme_classic()

ggsave("umapclustered.png", umap.hdbscan.3.plot, width = 5, height = 4,units = "in", dpi = 300)

plot.ssc_cd45.clustered <- mydata.stained.ss %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  ggplot(aes(x= ssc_a, y = cd45, col = cluster)) + 
  geom_point(shape = 15, size = 0.2) + 
  scale_color_discrete(guide = guide_legend(override.aes = list(
    shape = 15, size = 2
  ))) + 
  theme_bw()

ggsave("ssccd45clustered.png", plot.ssc_cd45.clustered, width = 4, height = 3,units = "in", dpi = 300)


plot.ssc_ax750.clustered <- mydata.stained.ss %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  ggplot(aes(y= alexa750, x = ssc_a, col = cluster)) + 
  geom_point(shape = 15, size = 0.1) + 
  scale_color_discrete(guide = guide_legend(override.aes = list(
    shape = 15, size = 2
  ))) + 
  scale_y_continuous(limits = c(0,7)) + 
  theme_bw()

ggsave("sscc750clustered.png", plot.ssc_ax750.clustered, width = 4, height = 3,units = "in", dpi = 300)


plot.ax750_po.clustered <- mydata.stained.ss %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  ggplot(aes(x= alexa750, y = pox6, col = cluster)) + 
  geom_point(shape = 15, size = 0.1) + 
  scale_color_discrete(guide = guide_legend(override.aes = list(
    shape = 15, size = 2
  ))) + 
  scale_y_continuous(limits = c(0,7)) + 
  scale_x_continuous(limits = c(0,7)) + 
  theme_bw()


plot.ax750_po.clustered
```

```{r}
library(gbm)
train.ind <- sample(seq(nrow(mydata.stained.ss)), 20e3)

mydata.train <- mydata.stained.ss %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  slice(train.ind)

mydata.test <- mydata.stained.ss %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) %>%
  slice(-train.ind)

gbm.cluster <- gbm(cluster ~ fsc_a + ssc_a + alexa750, 
    data = mydata.train, 
    distribution = "multinomial",
    n.trees = 10e3)

predicted.celltypes <- predict(gbm.cluster, newdata = mydata.test, 
                               n.trees = 10e3, type = 'response')


predicted.celltypes.u <- predict(gbm.cluster, newdata = uptake, 
                               n.trees = 10e3, type = 'response')

mydata.test %>%
mutate()
mutate(cluster = as.factor(apply(predicted.celltypes, 1, which.max)), 
       set = 'test')

library(tidyr)
mydata.test %>%
  mutate(cluster.pred = as.factor(apply(predicted.celltypes, 1, which.max))) %>%
  gather(set, cluster, cluster, cluster.pred) %>%
  mutate(set = as.factor(set)) %>%
  mutate(set = fct_recode(set,
                          `DBSCAN Cluster` = "cluster",
                          `Predicted Cluster` = "cluster.pred"
      )) %>%
  ggplot(aes(x = ssc_a, y = cd45, col = cluster)) +
  geom_point(shape = 15, size = .2) +
  scale_color_discrete(guide = guide_legend(override.aes = list(shape = 15, size = 2))) +
  theme_bw() +
  facet_grid(.~ set)

ggsave('dbscan_predicted.png', width = 6.5, height =3, units = "in", dpi = 300)  


mydata.test %>%
  bind_cols(as_tibble(predicted.celltypes[,,1])) %>%
  gather(cluster, probability, `1`, `2`, `3`, `4`) %>%
  ggplot(aes(x = ssc_a, y = cd45, col = probability)) +
  geom_point(shape = 15, size = .2) +
  scale_color_viridis_c(option = "D") + 
  theme_bw() +
  facet_wrap(~cluster, nrow = 1) + 
  theme(axis.text.x = element_blank())
ggsave('dbscan_predicted_probs.png', width = 8, height =2, units = "in", dpi = 300)  


mydata.test %>%
  mutate(cluster.pred = as.factor(apply(predicted.celltypes, 1, which.max))) %>%
  gather(set, cluster, cluster, cluster.pred) %>%
  mutate(set = as.factor(set)) %>%
  mutate(set = fct_recode(set,
                          `DBSCAN Cluster` = "cluster",
                          `Predicted Cluster` = "cluster.pred"
      )) %>%
  ggplot(aes(x = ssc_a, y = cd45, col = cluster)) +
  stat_density2d(n = 50, bins = 12) + 
  scale_color_discrete(guide = guide_legend(override.aes = list(shape = 15, size = 2))) +
  theme_bw() +
  facet_grid(.~ set)
ggsave('dbscan_predicted_contour.png', width = 7, height =3, units = "in", dpi = 300)  



```


```{r}
stained <- mydata.tidy$`Healthy Blood_Stained_020.fcs`
lm.data <- lm(pox6~alexa750, data = uptake)
#lm.data$coefficients[1]
lm.1 <- lm(pox6~1 + offset(1*alexa750), data = uptake)
#lm.data$coefficients[2]
lm.tibble <- tibble(slope = c(lm.data$coefficients[2], 1),
           intercept = c(lm.data$coefficients[1], lm.1$coefficients[1]), 
           model = c('data derived', 'slope = 1'))

uptake %>%
  ggplot(aes(x = alexa750, y = pox6)) +
  geom_bin2d(bins = 200)+ 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  geom_abline(aes(slope = slope, intercept = intercept, col = model), 
              data = lm.tibble, size = 0.5) + 
  scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = c("deeppink", "blue1")) + 
  theme_classic() + 
  coord_fixed() + 
  theme(panel.border = element_rect(color = 'black', fill = NA))

ggsave('poxax750.png', width = 3, height = 2, units = "in", dpi = 300)

lm.data <- lm(pbx8~alexa750, data = uptake)
lm.1 <- lm(pbx8~1 + offset(1*alexa750), data = uptake)
# lm.1 <- lm(pbx8~1, offset = alexa750, data = uptake)
# 
# lm.1 <- lm(pbx8 - alexa750~1, data = uptake)
# lm.1
lm.tibble <- 
  tibble(
    slope = c(lm.data$coefficients[2], 1),
    intercept = c(lm.data$coefficients[1], lm.1$coefficients[1]), 
    model = c('data derived', 'slope = 1')) %>%
  mutate(model = as.factor(model)) %>%
  mutate(model = fct_rev(model))

pbax750.plot <- uptake %>%
  ggplot(aes(x = alexa750, y = pbx8)) +
  geom_bin2d(bins = 200)+ 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  geom_abline(aes(slope = slope, intercept = intercept, col = model), 
              data = lm.tibble, size = 0.5) + 
  scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = c("#1b9e77", "#d95f02")) + 
  theme_classic() + 
  coord_fixed() + 
  theme(panel.border = element_rect(color = 'black', fill = NA))

ggsave('pbxax750.png', width = 3, height = 2, units = "in", dpi = 300)


pbxax750cl.plot <- uptake %>%
  mutate(cluster = hdbscan.ret) %>%
  ggplot(aes(x = alexa750, y = pbx8, group = cluster)) +
  geom_bin2d(bins = 200)+ 
  geom_smooth(method = "lm",
              se = F,
              data = (uptake %>%
                mutate(cluster = hdbscan.ret) %>%
                filter(cluster != 0)), 
              size = 0.5, 
              aes(color = "data derived\nby cluster")) +
  # geom_smooth(method = "lm",
  #             formula = y ~ 1 + offset(1*x),
  #           data = (uptake %>%
  #             mutate(cluster = hdbscan.ret) %>%
  #             filter(cluster != 0)), 
  #           size = 0.5, 
  #           color = "blue1") + 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  # geom_abline(aes(slope = slope, intercept = intercept, col = model), 
  #             data = lm.tibble, size = 0.5) + 
  scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = "#e7298a", name = "") + 
  scale_y_continuous(name = "Pacific Blue →") +
  scale_x_continuous(name = "Alexa 750 →") +
  theme_classic() + 
  coord_fixed() + 
  theme(panel.border = element_rect(color = 'black', fill = NA))

#ggsave('pbxax750_bygroup.png', width = 3, height = 2, units = "in", dpi = 300)

pbxax750_cl.plot <- uptake %>%
  mutate(cluster = hdbscan.ret)%>%
  ggplot(aes(x = alexa750, y = pbx8, col = cluster)) +
  geom_point_rast(shape = ".") + 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  # scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = mypal,
                     guide = guide_legend(override.aes = list(shape = 15))) + 
  theme_classic() + 
  coord_fixed() + 
  scale_y_continuous(name = "Pacific Blue →") +
  scale_x_continuous(name = "Alexa 750 →") +
  theme(panel.border = element_rect(color = 'black', fill = NA))

#pxax750_cl.plot
pbxax750.composite <- 
  (pbax750.plot + theme(axis.title = element_blank())) /
  (pbxax750cl.plot  + theme(axis.title = element_blank()))/ 
  (pbxax750_cl.plot)
#    pbxax750.composite
ggsave('pbxax750comp.png', width = 3, height = 5, units = "in", dpi = 300)
lm.dat.clust <- lm(pbx8~alexa750*cluster + cluster, data = uptake %>%  mutate(cluster = hdbscan.ret))

#lm.dat.clust
uptake %>%
  mutate(cluster = hdbscan.ret)%>%
  mutate(pbx8.pred.dat = predict(lm.data, newdata = .),
         pbx8.pred.1  = predict(lm.1, newdata = .), 
         pbx8.pred.dat.cl = predict(lm.dat.clust, newdata = .)) %>%
  mutate(pbx8.resid.dat = pbx8 - pbx8.pred.dat, 
         pbx8.resid.1 = pbx8 - pbx8.pred.1, 
         pbx8.resid.dat.cl = pbx8 - pbx8.pred.dat.cl) %>%
  gather(method, pbx8.resid, pbx8.resid.dat, pbx8.resid.1, pbx8.resid.dat.cl)%>%
  mutate(method = as.factor(method)) %>%
  mutate(method =fct_recode(method,
                            `data derived` = "pbx8.resid.dat",
                            `data derived, cl` = "pbx8.resid.dat.cl",
                            `slope = 1` = "pbx8.resid.1")) %>%
  ggplot(aes(x = alexa750, y = pbx8.resid)) +
  geom_bin2d(bins = 200)+ 
  geom_hline(yintercept = 0, color = 'grey50', linetype =2, size = 0.5) + 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = c("deeppink", "blue1")) + 
  theme_classic() + 
  coord_fixed() + 
  facet_wrap(~method, nrow = 3) + 
  theme(panel.border = element_rect(color = 'black', fill = NA))

ggsave('pbxax750_resid.svg', width = 3, height = 6, units = "in", dpi = 300)

#mypal <- c("grey50", hue_pal()(4))
uptake %>%
  mutate(cluster = hdbscan.ret)%>%
  mutate(pbx8.pred.dat = predict(lm.data, newdata = .),
         pbx8.pred.1  = predict(lm.1, newdata = .), 
         pbx8.pred.dat.cl = predict(lm.dat.clust, newdata = .)) %>%
  mutate(pbx8.resid.dat = pbx8 - pbx8.pred.dat, 
         pbx8.resid.1 = pbx8 - pbx8.pred.1, 
         pbx8.resid.dat.cl = pbx8 - pbx8.pred.dat.cl) %>%
  gather(method, pbx8.resid, pbx8.resid.dat, pbx8.resid.1, pbx8.resid.dat.cl)%>%
  mutate(method = as.factor(method)) %>%
  mutate(method =fct_recode(method,
                            `data derived` = "pbx8.resid.dat",
                            `data derived, cl` = "pbx8.resid.dat.cl",
                            `slope = 1` = "pbx8.resid.1")) %>%
  ggplot(aes(x = alexa750, y = pbx8.resid, col = cluster)) +
  geom_point_rast(shape = ".") + 
  geom_hline(yintercept = 0, color = 'grey50', linetype =2, size = 0.5) + 
  # geom_point(shape = 15, size = 0.2) +
  # stat_density2d(bins = 20, aes(fill = stat(nlevel)), geom = "polygon",
  #                col = NA)+
  # scale_fill_viridis_c(option = "A", guide = FALSE) + 
  scale_color_manual(values = mypal,
                     guide = guide_legend(override.aes = list(shape = 15))) + 
  theme_classic() + 
  coord_fixed() + 
  facet_wrap(~method, nrow = 3) + 
  theme(panel.border = element_rect(color = 'black', fill = NA))




ggsave('pbxax750_resid_pt.svg', width = 3, height = 6, units = "in", dpi = 300)


```





```{r}
uptake <- mydata.tidy$`Healthy Blood_Uptake_021.fcs`

uptake.mapping <- uptake %>%
  select(pox6, pbx8, alexa750) 

#uptake.clustering <- hdbscan(uptake.mapping, minPts = 50)

uptake.clustering
predicted.celltypes.u <- predict(gbm.cluster, newdata = uptake, 
                               n.trees = 10e3, type = 'response')
#?use_python
hdbscan.ret <- hdbscan_(uptake.mapping, algorithm='prims_kdtree', min_cluster_size = 100L)

h <- reticulate::import("hdbscan")
cl <- h$HDBSCAN(min_samples = 7L,
                min_cluster_size = 100L,
                algorithm= 'prims_kdtree')
cl.fit <- cl$fit(as.matrix(uptake.mapping))
str(cl.fit$exemplars_)

#labels <- cl$fit_predict(as.matrix(uptake.mapping))
approx.pred <- h$approximate_predict(cl, as.matrix(uptake.mapping))
uptake.mapping %>%
  mutate(cluster = as.factor(approx.pred[[1]]+1)) %>%
  mutate(cluster = as.factor(labels)) %>%
  ggplot(aes(x=alexa750, y = pox6, col = cluster)) + 
  geom_point(shape = ".")

uptake.mapping %>%
  mutate(cluster = hdbscan.ret) %>%
  ggplot(aes(x=alexa750, y = pox6, col = cluster)) +
  geom_point(shape = ".")

#hdbscan.ret
mydata.tidy$`Healthy Blood_Uptake_021.fcs`
u.po.ax750.plot <- mydata.tidy$`Healthy Blood_Uptake_021.fcs` %>%
  #gather(bc, value, pox6, pbx8) %>%
  ggplot(aes(y= pox6, x = alexa750)) + 
  geom_bin2d(bins = 200, aes(fill = stat(ndensity))) + 
  scale_y_continuous(limits = c(0,7), name = "Pacific Orange") + 
  scale_x_continuous(limits = c(0,7), name = "Alexa 750") + 
 # scale_fill_viridis_c(option = "A") + 
  scale_fill_distiller(palette = "Spectral") +
  theme_bw() #+ 
  #facet_grid(.~bc)

mydata.tidy$`Healthy Blood_Uptake_021.fcs` %>%
  mutate(cluster = as.factor(uptake.clustering$cluster)) %>%
  #gather(bc, value, pox6, pbx8) %>%
  ggplot(aes(y= pox6, x = alexa750, col = cluster)) + 
  geom_point(shape = 15, size = 0.2) + 
  scale_y_continuous(limits = c(0,7), name = "Pacific Orange") + 
  scale_x_continuous(limits = c(0,7), name = "Alexa 750") + 
  theme_bw() #+ 

u.pb.ax750.plot <- 
  mydata.tidy$`Healthy Blood_Uptake_021.fcs` %>%
  bind_cols(as_tibble(predicted.celltypes.u[,,1])) %>%
  gather(cluster, probability, `1`, `2`, `3`, `4`) %>%
  ggplot(aes(y= pbx8, x = alexa750, col = probability)) + 
  geom_point(shape =15, size = 0.1) + 
  scale_y_continuous(limits = c(0,7), name = "Pacific Blue") + 
  scale_x_continuous(limits = c(0,7), name = "Alexa 750") + 
  scale_color_viridis_c(option = "D") + 
  theme_bw() + 
  facet_grid(~cluster)

#u.pb.ax750.plot <- 
  mydata.tidy$`Healthy Blood_Uptake_021.fcs` %>%
  mutate(cluster = as.factor(apply(predicted.celltypes.u, 1, which.max))) %>%
  ggplot(aes(y= pbx8, x = alexa750, col = cluster)) + 
  geom_point(shape =15, size = 0.1) + 
  scale_y_continuous(limits = c(0,7), name = "Pacific Blue") + 
  scale_x_continuous(limits = c(0,7), name = "Alexa 750") + 
  #scale_color_viridis_c(option = "D") + 
  theme_bw()

u.pb.ax750.plot

mydata.tidy$`Healthy Blood_Uptake_021.fcs` %>%
  ggplot(aes(y= pbx8, x = alexa750)) + 
  geom_bin2d(bins = 200, aes(fill = stat(ndensity))) + 
  scale_y_continuous(limits = c(0,7), name = "Pacific Blue") + 
  scale_x_continuous(limits = c(0,7), name = "Alexa 750") + 
 # scale_fill_viridis_c(option = "A") + 
  scale_fill_distiller(palette = "Spectral") +
  
  theme_bw() #+ 
u.pb.ax750.plot


install.packages("reticulate")
library(reticulate)
```


```{r}
train.ind <- sample(seq(nrow(uptake)), 20e3)

uptake.fit <- uptake %>%
 # mutate_all(function(col) rescale(col, c(0,7)))  %>%
  bind_cols(as_tibble(predicted.celltypes.u[,,1])) %>%
  mutate(cluster = as.factor(apply(predicted.celltypes.u, 1, which.max))
  )

#uptake.fit
uptake.train <- uptake.fit[train.ind, ]# %>%
  select(pbx8, alexa750, ssc_a, fsc_a) %>%
  mutate_all(function(col) rescale(col, c(0,7))) 

  
uptake.test <- uptake.fit[-train.ind, ] # %>%
  select(pbx8, alexa750, ssc_a, fsc_a) %>%
  mutate_all(function(col) rescale(col, c(0,7)))

#library(gbm)
#uptake.train
pb.mod <- gbm(pbx8 ~ alexa750 + ssc_a + fsc_a,
                data = uptake.train, 
                distribution = "gaussian", n.trees = 10000, 
                cv.folds = 4)
n.trees.pb <- gbm.perf(pb.mod, method = "OOB", oobag.curve = TRUE)

gbmGrid <-  expand.grid(interaction.depth = c(1, 5, 9), 
                        n.trees = (1:10)*150, 
                        shrinkage = c(0.01, 0.1, 1),
                        n.minobsinnode = c(10,20,40))

pb.mod2 <- gbm(pbx8 ~ alexa750 + ssc_a + fsc_a + live_dead,
                data = uptake.train, 
                distribution = "gaussian", n.trees = n.trees.pb, 
                cv.folds = 4)

library(caret)
fitControl <- trainControl(## 10-fold CV
                           method = "repeatedcv",
                           number = 10,
                           ## repeated ten times
                           repeats = 10)

gbmGrid <-  expand.grid(interaction.depth = c(1, 5, 9), 
                        n.trees = 5e3, 
                        shrinkage = c(0.01, 0.1, 1),
                        n.minobsinnode = c(10,20,40))


uptake.umap <- uwot::umap(uptake.fit %>% select(alexa750, ssc_a, fsc_a), min_dist = 0, verbose = T)

as_tibble(uptake.umap) %>%
  ggplot(aes(x = V1,y = V2)) + geom_bin2d(bins = 200)

pb.mod2 <- gbm(pbx8 ~ alexa750 + ssc_a + fsc_a + live_dead,
                data = uptake.train, 
                distribution = "gaussian", n.trees = n.trees.pb, 
                cv.folds = 4)

gbmFit2 <- train(pbx8 ~ alexa750 + ssc_a + fsc_a, data = uptake.train, 
                 method = "gbm", 
                 trControl = fitControl,
                 ## This last option is actually one
                 ## for gbm() that passes through
                 verbose = FALSE, 
                 tuneGrid = gbmGrid)

install.packages("earth")
library(earth)
mydata.stained.ss %>%
  bind_cols(
  as_tibble(umap.3$embedding) %>%
  mutate(cluster = as.factor(hdbscan.3$cluster)) )

# 
# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a,
#   degree = 4,
#   nfold = 3,
#   fast.beta = 0,
#  # linpreds = "alexa750",
#   data = uptake.fit,
#   minspan = 2)

#?earth

# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a + ssc_w + fsc_w + live_dead, 
#   degree = 3,
#   nfold = 3,
#  # linpreds = "alexa750",
#   data = uptake.fit)



# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a
#   degree = 4,
#   nfold = 3,
#   linpreds = "alexa750",
#   data = uptake.fit,
#   nk = 20)
# #plotmo(pb.earth)
#summary(pb.earth)

# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a,
#   degree = 4,
#   nfold = 3,
#   fast.beta = 0,
#  # linpreds = "alexa750",
#   data = uptake.fit,
#   minspan = 2)
# 
# # pb.earth <- earth(
# #   pbx8 ~ alexa750 + ssc_a + fsc_a,
# #   degree = 3,
# #   nfold = 3,
# #  # linpreds = "alexa750",
# #   data = uptake.fit,
# #   pmethod="cv")
# # 
# 
# uptake.fit2 <-
#   uptake.fit %>%
#   bind_cols(as_tibble(uptake.umap))
# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a,
#   degree = 4,
#   nfold = 3,
#   fast.beta = 0,
#  # linpreds = "alexa750",
#   data = uptake.fit,
#   minspan = 2)
# 
# pb.earth <- earth(
#   pbx8 ~ V1 + V2,
#   degree = 2,
#   nfold = 3,
#   fast.beta = 0,
#  # linpreds = "alexa750",
#   data = uptake.fit2,
#   minspan = 2)
library(earth)
celltype.mars <-  earth(
  clust ~ fsc_a + ssc_a,
  degree = 3,
  nfold = 3,
 # linpreds = "alexa750",
  data = mydata.stained.ss %>%
  mutate(clust = as.factor(hdbscan.3$cluster)))



#plotmo(celltype.mars, nresponse = 4)
celltype.pred <- predict(celltype.mars, newdata = stained)



celltype.pred.u <- predict(celltype.mars, newdata = uptake.fit)

mydata.stained.cl<- stained %>%
  mutate(cluster.pred = as.factor(apply(celltype.pred, 1, which.max)))

mydata.uptake.cl<- uptake.fit %>%
  mutate(cluster_pred = as.factor(apply(celltype.pred.u, 1, which.max)))

#mydata.uptake.cl



po.earth <- earth(
  pox6 ~ alexa750 + ssc_a + fsc_a + cluster_pred,
  degree = 3,
  nfold = 3,
 # linpreds = "alexa750",
  data = mydata.uptake.cl)
#
#hdbscan.3
#predicted.celltypes <- predict(gbm.cluster, newdata = stained, 
 #                              n.trees = 10e3, type = 'response')
#summary(pb.earth)
mydata.stained.train <- mydata.stained.ss %>%
  mutate(clust = as.factor(hdbscan.3$cluster)) 

celltype.mars <-  earth(
  clust ~ fsc_a + ssc_a + alexa750,
  degree = 3,
  nfold = 3,
 # linpreds = "alexa750",
  data = mydata.stained.train)

#?earth
#plotmo(celltype.mars, nresponse = 4)
celltype.pred <- predict(celltype.mars, newdata = stained)

mydata.stained.cl<- stained %>%
  mutate(cluster_pred = as.factor(apply(celltype.pred, 1, which.max)))

mydata.stained.cl %>%
  sample_n(50e3) %>%
  ggplot(aes(x=ssc_a, y = cd45, col = cluster_pred)) + 
  geom_point(shape = 15)

mydata.stained.ss %>%
  mutate(clust = as.factor(hdbscan.3$cluster)) %>%
  ggplot(aes(x=ssc_a, y = cd45, col = clust)) + 
  geom_point()

# 
# pb.earth <- earth(
#   pbx8 ~ alexa750 + ssc_a + fsc_a + cluster_pred,
#   degree = 3,
#   nfold = 3,
#   trace = 0,
#   pmethod = "none",
#  # linpreds = "cluster_pred",
#   data = mydata.uptake.cl)
# 
# summary(pb.earth)
# po.earth <- earth(
#   pox6 ~ alexa750 + ssc_a + fsc_a + cluster_pred,
#   degree = 3,
#   nfold = 3,
#  # linpreds = "alexa750",
#   data = mydata.uptake.cl)

pb.pred <- predict(pb.earth, newdata = mydata.uptake.cl)
pb.pred <- predict(pb.earth, newdata = mydata.uptake.cl, interval = "se")

pb.earth <- earth(
  pbx8 ~ alexa750 + ssc_a + fsc_a + `1` + `2` + `3` + `4`,
  degree = 3,
  penalty = -1,
  trace = 1,
  fast.beta = 0,
 # linpreds = "cluster_pred",
  data = mydata.uptake.cl)

summary(pb.earth)
install.packages("mda")
stained %>%
  bind_cols(as_tibble(celltype.pred)) %>%
  mutate(pbx8.pred = predict(pb.earth, newdata = .),
         #pbx8.resid2 = residuals(pb.earth, type = "delever"),
         pbx8.resid = pbx8 - pbx8.pred,
         #pbx8.var = predict(pb.earth, newdata = ., interval = "se")
         NULL) %>%
  #gather(model, pbx8, pbx8, pbx8.pred) %>%
  #mutate(model = as.factor(model), 
   #      model = fct_recode(model, 
    #                        Original = "pbx8", 
     #                       Predicted = "pbx8.pred")) %>%
#  sample_n(200e3) %>%
  ggplot(aes(x=alexa750, y = pbx8.resid, col = cluster_pred)) +
  geom_point(shape = ".") + 
#  scale_color_viridis_c(trans = "sqrt") + 
  #geom_bin2d(bins = 200, aes(fill = stat(ndensity))) + 
  scale_fill_distiller(palette = "Spectral") +
#  facet_wrap(~cluster_pred, nrow = 2) + 
  theme_classic()




mydata.uptake.cl %>%
  mutate(pbx8.pred = predict(pb.earth, newdata = .),
         pbx8.resid = pbx8 - pbx8.pred, 
         pox6.pred = predict(po.earth, newdata = .),
         pox6.resid = pox6 - pox6.pred) %>%
  #gather(model, pbx8, pbx8, pbx8.pred) %>%
  #mutate(model = as.factor(model), 
   #      model = fct_recode(model, 
    #                        Original = "pbx8", 
     #                       Predicted = "pbx8.pred")) %>%
  #sample_n(200e3) %>%
  ggplot(aes(x=pox6.resid, y = pbx8.resid)) + 
  geom_point(shape = ".", alpha = 0.1) + 
  #geom_bin2d(bins = 200, aes(fill = stat(ndensity))) + 
  scale_fill_distiller(palette = "Spectral") +
 # facet_wrap(~cluster_pred, nrow = 2) + 
  theme_classic()




mydata.stained.cl %>%
  mutate(pbx8.pred = predict(pb.earth, newdata = .),
         pbx8.resid = pbx8 - pbx8.pred, 
         pox6.pred = predict(po.earth, newdata = .),
         pox6.resid = pox6 - pox6.pred) %>%
  #gather(model, pbx8, pbx8, pbx8.pred) %>%
  #mutate(model = as.factor(model), 
   #      model = fct_recode(model, 
    #                        Original = "pbx8", 
     #                       Predicted = "pbx8.pred")) %>%
  sample_n(200e3) %>%
  ggplot(aes(x=pox6.resid, y = pbx8.resid, col = cluster_pred)) + 
  geom_point(shape = ".", alpha = 0.1) + 
  #geom_bin2d(bins = 200, aes(fill = stat(ndensity))) + 
  scale_fill_distiller(palette = "Spectral") +
#  facet_wrap(~cluster_pred, nrow = 2) + 
  theme_classic()

```
## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

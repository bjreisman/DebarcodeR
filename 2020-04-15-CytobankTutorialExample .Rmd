---
title: "DebarcodeR Example"
author: "Benjamin Reisman and Sierra Barone"
date: "03/16/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load libraries and read in data

Load flowCore, tidyverse, and debarcoder packages. Read in FCS files for the stained sample and the uptake control sample

```{r setup}

# load libraries
library(flowCore)
library(flowWorkspace)
library(CytoML)
library(ncdfFlow)
library(debarcoder)
library(patchwork)

myacs <- list.files(pattern = ".acs")
ce <- open_cytobank_experiment(myacs)
gs <- cytobank_to_gatingset(ce)

fcsFiles <- list.files(ce$fcsdir, full.names = TRUE)


gs <- cytobank_to_gatingset(xmlfile, fcsFiles)

fs.ncdf <- gs_pop_get_data(gs, "intact cells")

trans

debug(cytobank_to_gatingset)
#fs.ncdf <- gs_pop_get_data(gs, "singlets")
fs.ncdf %>%
  ggplot(aes(x=`SSC-A`, y = `FSC-A`)) + 
  geom_bin2d(bins= 300) 
#getNodes(gs)
fs <- ncdfFlow::as.flowSet(fs.ncdf)
fs
```

# Create debarcoder object

Create flowFrame FCB with slots filled with barcoded and uptake samples

```{r create debarcodeR object}
# test class of flowFrameFCB object
class(flowFrameFCB)

# create flowFrameFCB object using barcoded and uptake control sample as flowFrames
flowFrameFCB <- flowFrameFCB(fs@frames$`Panel 1 - pERK pp38_Pan1.fcs`)
                              
# plot Pacific Blue and Pacific Orange histograms 
hist(flowFrameFCB@barcoded.ff@exprs[,"Alexa 700-A"], n= 600, main = NULL, xlab = "Alexa 750")
hist(flowFrameFCB@barcoded.ff@exprs[,"Pacific Orange-A"], n= 600, main = NULL, xlab = "Pacific Orange")

```
# Deskew barcoding channel using a regression method

Deskew each barcoding channel individually choosing predictors, method, and channel
```{r deksew flowFrameFCB data}
library(ggpointdensity)
# Input debarcoder object and choose predictors, method, and channel to deskew (BC1)
# Deskew first barcoded channel
deskewedFCB <- deskew_flowFrameFCB(flowFrameFCB, ret.model = T, predictors = c("fsc_a","ssc_a"),# "fsc_h", "fsc_w", "ssc_h", "ssc_w"),
                                   channel = c("pacific_orange_a"), method = c("earth"), 
                                   uptake = fs@frames$`Compensation Controls_Pacific Orange Stained Control.fcs`)
deskewedFCB <- deskew_flowFrameFCB(deskewedFCB, ret.model = T, predictors = c("fsc_a","ssc_a"),# "fsc_h", "fsc_w", "ssc_h", "ssc_w"),
                                   channel = c("alexa_700_a"), method = c("earth"), 
                                   uptake = fs@frames$`Compensation Controls_Alexa 700 Stained Control.fcs`)

plot.deskewed <- as.data.frame(flowFrameFCB@barcoded.ff, use_longnames = F)  %>%
mutate(`Pacific Orange-A` = deskewedFCB@barcodes$pacific_orange_a$deskewing$values, 
       `Alexa 700-A` = deskewedFCB@barcodes$alexa_700_a$deskewing$values) %>%
  ggplot(aes(y = `Pacific Orange-A`, x = `SSC-A`)) + 
  geom_bin2d(bins = 200) + 
  scale_fill_viridis_c(option = "A", guide = F) + 
  scale_y_continuous(limits = c(-1,5)) 
plot.orig <- as.data.frame(flowFrameFCB@barcoded.ff, use_longnames = F)  %>%
  ggplot(aes(y = `Pacific Orange-A`, x = `SSC-A`)) + 
  geom_bin2d(bins = 200) + 
  scale_fill_viridis_c(option = "A", guide = F) + 
  scale_y_continuous(limits = c(-1,5))

combiplot <- plot.orig + plot.deskewed 
library(earth)
?plotmo
par()

?svg()
plotmo(deskewedFCB@barcodes$pacific_orange_a$deskewing$model,pt.col = "black",# smooth.col = "red", nrug="density",
    #   do.par=FALSE,# ngrid2 = 50, 
    #   persp.border=NA, 
       npoints = 1000,
       ylim = c(1,6),
       pt.pch = ".",
    main = c("FSC-A", "SSC-A","FSC:SSC-A"),
    ylab = c("Pacific Orange-A", "", ""),  mfrow=c(1,3),
    y.ticks = NA,
    caption = "")
  combiplot & theme_bw() & theme(panel.grid = element_blank(), axis.text = element_blank())

plot.deskewed = as.data.frame(cbind( deskewedFCB@barcodes$pacific_orange_a$deskewing$values,  deskewedFCB@barcodes$pacific_blue_a$deskewing$values))

  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_blue_a, y = `Alexa Fluor 700-A`)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()

  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_orange_a, y = `Alexa Fluor 700-A`)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()
  
  bind_cols(plot.deskewed) %>%
  bind_cols(as.data.frame(flowFrameFCB@barcoded.ff@exprs)) %>%
  ggplot(aes(x=pacific_orange_a, y = pacific_blue_a)) +
  geom_bin2d( bins= 300) + 
  scale_fill_viridis_c(option = "A") +
  theme_bw()
```
# Apply clustering and modeling to deskewed flowFrameFCB

Calculate probabilities of cells belonging to a level of barcode
```{r modeling}

# Input deskewed debarcoder object and choose number of levels, option, distribution, and channel to cluster (BC1)
# Cluster first barcoded channel
clusteredFCB <- cluster_flowFrameFCB(deskewedFCB, channel = c("pacific_blue_a"), levels = 8, opt = "mixture", dist = "Skew.normal")

# Input new clustered object and cluster new barcoded channel
clusteredFCB <- cluster_flowFrameFCB(clusteredFCB, channel = c("pacific_orange_a"), levels = 6, opt = "mixture", dist = "Skew.normal")

```
# Assign cells to levels of barcode based on ambiguity and uncertainty

Assign cells to levels based on probabilities and various cutoffs
```{r assignment}

# Input clustered debarcoder object and choose likelihood cutoff, ambiguity cutoff, and channel to assign(BC1)
# Assign cells to levels of first barcoded channel
assignmentFCB <- assign_flowFrameFCB(clusteredFCB, channel = c("pacific_blue_a") , likelihoodcut = 8, ambiguitycut = 0.2)

# Input new f;owFrameFCB with assignments and apply assignments to other barcoded channel
assignmentFCB <- assign_flowFrameFCB(assignmentFCB, channel = c("pacific_orange_a") , likelihoodcut = 8, ambiguitycut = 0.2)

mypal <- c("grey50", scales::hue_pal()(length(unique(assignmentFCB@barcodes$pacific_blue_a$assignment$values))-1))

bind_cols(plot.deskewed) %>%
  mutate(pblevel = as.factor(assignmentFCB@barcodes$pacific_blue_a$assignment$values)) %>%
  ggplot(aes(x=pacific_blue_a, fill = pblevel)) +
  geom_histogram(bins = 300)  +
  scale_fill_manual(values = mypal) + theme_bw()

bind_cols(plot.deskewed) %>%
  mutate(polevel = as.factor(assignmentFCB@barcodes$pacific_orange_a$assignment$values)) %>%
  ggplot(aes(x=pacific_orange_a, fill = polevel)) +
  geom_histogram(bins = 300)  +
  scale_fill_manual(values = mypal) + theme_bw()

# Write new FCS files per well 
debarcoded.fs <- as.flowSet(assignmentFCB)

probs.norm.row <- calculate.ambiguity(clusteredFCB,channel = c("pacific_blue_a"))
probs.norm.col <- calculate.likelihood(clusteredFCB,channel = c("pacific_blue_a"))
classif <- as.numeric(apply(probs.norm.row, 1, which.max))

test <- list()
count = 1
for (i in rev(seq(0.01,1,by = 0.01))){
non.ambiguous <- apply(probs.norm.row, 1, max) > (1 - i)
not.am = classif[which(non.ambiguous)]
test[[count]] = summary(as.factor(not.am))
count = count + 1}

counts = plyr::ldply(test,rbind)
counts$cutoff = rev(seq(0.01,1,by = 0.01))

meltR = reshape2::melt(counts, id.vars = "cutoff", measure.vars = c(1:8))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()


tests <- list()
counting = 1

for (s in rev(seq(2,100,by = 1))){
    likely <- probs.norm.col > 1/s
    likely.sum <- apply(likely, 1, sum) 
    most.likely = classif[which(likely.sum > 0)]
tests[[counting]] = summary(as.factor(most.likely))
counting = counting + 1}

look.at.counts = plyr::ldply(tests,rbind)
look.at.counts$cutoff = rev(seq(2,100,by = 1))

meltR = reshape2::melt(look.at.counts, id.vars = "cutoff", measure.vars = c(1:8))
ggplot(data = meltR, mapping = aes(x = cutoff, y = value, color = variable)) +
    geom_line() + theme_bw()

```
